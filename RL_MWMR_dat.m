%% Simulation RL for Mecanum Wheeled Mobile Robot
clc;clear;close all;
%% Time interval and simulation time
Step = 0.001;T_end = 150;
t = 0:Step:T_end;
%% Variables
q_r = cell(1,size(t,2));
q_r_dot = cell(1,size(t,2));

q = cell(1,size(t,2));
%q_dot = cell(1,size(t,2));

upsilon = cell(1,size(t,2)); % upsilon = v_q
upsilon_dot = cell(1,size(t,2));

upsilon_r = cell(1,size(t,2));
upsilon_r_dot = cell(1,size(t,2));

x = cell(1,size(t,2));
x_r = cell(1,size(t,2));

e = cell(1,size(t,2));

z = cell(1,size(t,2));

W_c = cell(1,size(t,2));
W_a = cell(1,size(t,2));
gamma_h = cell(1,size(t,2));

V_z = cell(1,size(t,2));
grad_V_z = cell(1,size(t,2));
tau = cell(1,size(t,2));
%% Parameter
m = 10; % Mass (kg)
l = 0.5; % Length of MWMR (m)
r = 0.05; % Wheeled radius (m)
I_theta = 5; I_phi = 0.1; % Rotational inertia (kg.m^2)
muy = 1; % Friction coefficients (N.m/rad/s)

ro = 0.1; % External disturbance
% ro = -0.1
Q = eye(6); % Positive-definite matrix
R = eye(3); % Positive-definite symmetric constant matrix
n_NN = 51; % Number of NN nodes
% The control gain
eta_c = 6.37;
eta_a1 = 7.8;
eta_a2 = 0.001;
eta_a = 0.001;
beta = 0.001;
gama = 0.0001;
v = 0.002;
%% Initial Conditions
q{1} = [1.8; 1.6; 1.4];
upsilon{1} = [0; 0; 0];
W_c{1} = 200*rand(n_NN,1);
W_a{1} = 6*rand(n_NN,1);
gamma_h{1} = 10*rand(n_NN,1);
%% System simulation
for i = 1:size(t,2)
    m1 = ((4*m*r^2)/9) + (I_theta*r^2)/(9*l^2) + I_phi;
    m2 = (I_theta*r^2)/(9*l^2) - (2*m*r^2)/9;
%M
    M = [m1 m2 m2; m2 m1 m2; m2 m2 m1];
    q_x = q{i}(1); q_y = q{i}(2); q_theta = q{i}(3);
% H^-1, H_cham
    H_inv = [sin(q_theta + pi/3) -cos(q_theta + pi/3) -l; -sin(q_theta) cos(q_theta) -l; sin(q_theta-pi/3) -cos(q_theta-pi/3) -l];
    dH_inv = [cos(q_theta + pi/3) sin(q_theta + pi/3) 0; -cos(q_theta) -sin(q_theta) 0; cos(q_theta - pi/3) sin(q_theta - pi/3) 0];
    dH = (inv(H_inv))*dH_inv*(inv(H_inv));
%f_q
    f_q = dH*H_inv - muy*(inv(H_inv))*(inv(M))*H_inv;
%g_q
    g_q = r*(inv(H_inv))*(inv(M));
%fd(q,vq)
    f_d_q_vq = -ro*(f_q*upsilon{i});
%d(q,v_q)
    d_q_vq = (inv(g_q))*f_d_q_vq;
% model
    x{i} = [q{i}' upsilon{i}']'; % upsilon = v_q
    f_x = [upsilon{i}' (f_q*upsilon{i})']';
    g_x = [zeros(3) (g_q)']';
%% reference trajectory
    q_r{i} = [0.5*cos(2*t(i)) cos(t(i)) cos(0.5*t(i))]';
    q_r_dot{i} = [-0.5*2*sin(2*t(i)) -sin(t(i)) -0.5*cos(0.5*t(i))]';
    x_r{i} = [q_r{i}' q_r_dot{i}']';
%% Tracking error
    e{i} = x{i} - x_r{i};
    z{i} = [e{i}' x_r{i}']';
%% Activation Function
% phi_z = zeros(51,1);
    phi_z = (1/2)*[z{i}(1)^2 z{i}(2)^2 z{i}(3)^2 ...
    z{i}(1)*z{i}(4) z{i}(1)*z{i}(5) z{i}(1)*z{i}(6) z{i}(2)*z{i}(4) z{i}(2)*z{i}(5) z{i}(2)*z{i}(6) ...
    z{i}(3)*z{i}(4) z{i}(3)*z{i}(5) z{i}(3)*z{i}(6) (z{i}(1)^2)*(z{i}(2)^2) (z{i}(1)^2)*(z{i}(3)^2) ...
    (z{i}(2)^2)*(z{i}(3)^2) (z{i}(1)^2)*(z{i}(7)^2) (z{i}(1)^2)*(z{i}(8)^2) (z{i}(1)^2)*(z{i}(9)^2) ...
    (z{i}(1)^2)*(z{i}(10)^2) (z{i}(1)^2)*(z{i}(11)^2) (z{i}(1)^2)*(z{i}(12)^2) (z{i}(2)^2)*(z{i}(7)^2) ...
    (z{i}(2)^2)*(z{i}(8)^2) (z{i}(2)^2)*(z{i}(9)^2) (z{i}(2)^2)*(z{i}(10)^2) (z{i}(2)^2)*(z{i}(11)^2) ...
    (z{i}(2)^2)*(z{i}(12)^2) (z{i}(3)^2)*(z{i}(7)^2) (z{i}(3)^2)*(z{i}(8)^2) (z{i}(3)^2)*(z{i}(9)^2) ...
    (z{i}(3)^2)*(z{i}(10)^2) (z{i}(3)^2)*(z{i}(11)^2) (z{i}(3)^2)*(z{i}(12)^2) (z{i}(4)^2)*(z{i}(7)^2) ...
    (z{i}(4)^2)*(z{i}(8)^2) (z{i}(4)^2)*(z{i}(9)^2) (z{i}(4)^2)*(z{i}(10)^2) (z{i}(4)^2)*(z{i}(11)^2) ...
    (z{i}(4)^2)*(z{i}(12)^2) (z{i}(5)^2)*(z{i}(7)^2) (z{i}(5)^2)*(z{i}(8)^2) (z{i}(5)^2)*(z{i}(9)^2) ...
    (z{i}(5)^2)*(z{i}(10)^2) (z{i}(5)^2)*(z{i}(11)^2) (z{i}(5)^2)*(z{i}(12)^2) (z{i}(6)^2)*(z{i}(7)^2) ...
    (z{i}(6)^2)*(z{i}(8)^2) (z{i}(6)^2)*(z{i}(9)^2) (z{i}(6)^2)*(z{i}(10)^2) (z{i}(6)^2)*(z{i}(11)^2) ...
    (z{i}(6)^2)*(z{i}(12)^2)];
% grad_phi_z = zeros(51,12);
    grad_phi_z = (1/2)*[2*z{i}(1) 0 0 0 0 0 0 0 0 0 0 0; ...
    0 2*z{i}(2) 0 0 0 0 0 0 0 0 0 0; ...
    0 0 2*z{i}(3) 0 0 0 0 0 0 0 0 0; ...
    z{i}(4) 0 0 z{i}(1) 0 0 0 0 0 0 0 0; ...
    z{i}(5) 0 0 0 z{i}(1) 0 0 0 0 0 0 0; ...
    z{i}(6) 0 0 0 0 z{i}(1) 0 0 0 0 0 0; ...
    0 z{i}(4) 0 z{i}(2) 0 0 0 0 0 0 0 0; ...
    0 z{i}(5) 0 0 z{i}(2) 0 0 0 0 0 0 0; ...
    0 z{i}(6) 0 0 0 z{i}(2) 0 0 0 0 0 0; ...
    0 0 z{i}(4) z{i}(3) 0 0 0 0 0 0 0 0; ...
    0 0 z{i}(5) 0 z{i}(3) 0 0 0 0 0 0 0; ...
    0 0 z{i}(6) 0 0 z{i}(3) 0 0 0 0 0 0; ...
    2*z{i}(1)*(z{i}(2)^2) 2*(z{i}(1)^2)*z{i}(2) 0 0 0 0 0 0 0 0 0 0; ...
    2*z{i}(1)*(z{i}(3)^2) 0 2*(z{i}(1)^2)*z{i}(3) 0 0 0 0 0 0 0 0 0; ...
    0 2*z{i}(2)*(z{i}(3)^2) 2*(z{i}(2)^2)*z{i}(3) 0 0 0 0 0 0 0 0 0; ...
    2*z{i}(1)*(z{i}(7)^2) 0 0 0 0 0 2*(z{i}(1)^2)*z{i}(7) 0 0 0 0 0; ...
    2*z{i}(1)*(z{i}(8)^2) 0 0 0 0 0 0 2*(z{i}(1)^2)*z{i}(8) 0 0 0 0; ...
    2*z{i}(1)*(z{i}(9)^2) 0 0 0 0 0 0 0 2*(z{i}(1)^2)*z{i}(9) 0 0 0; ...
    2*z{i}(1)*(z{i}(10)^2) 0 0 0 0 0 0 0 0 2*(z{i}(1)^2)*z{i}(10) 0 0; ...
    2*z{i}(1)*(z{i}(11)^2) 0 0 0 0 0 0 0 0 0 2*(z{i}(1)^2)*z{i}(11) 0; ...
    2*z{i}(1)*(z{i}(12)^2) 0 0 0 0 0 0 0 0 0 0 2*(z{i}(1)^2)*z{i}(12); ...
    0 2*z{i}(2)*(z{i}(7)^2) 0 0 0 0 2*(z{i}(2)^2)*z{i}(7) 0 0 0 0 0; ...
    0 2*z{i}(2)*(z{i}(8)^2) 0 0 0 0 0 2*(z{i}(2)^2)*z{i}(8) 0 0 0 0; ...
    0 2*z{i}(2)*(z{i}(9)^2) 0 0 0 0 0 0 2*(z{i}(2)^2)*z{i}(9) 0 0 0; ...
    0 2*z{i}(2)*(z{i}(10)^2) 0 0 0 0 0 0 0 2*(z{i}(2)^2)*z{i}(10) 0 0; ...
    0 2*z{i}(2)*(z{i}(11)^2) 0 0 0 0 0 0 0 0 2*(z{i}(2)^2)*z{i}(11) 0; ...
    0 2*z{i}(2)*(z{i}(12)^2) 0 0 0 0 0 0 0 0 0 2*(z{i}(2)^2)*z{i}(12); ...
    0 0 2*z{i}(3)*(z{i}(7)^2) 0 0 0 2*(z{i}(3)^2)*z{i}(7) 0 0 0 0 0; ...
    0 0 2*z{i}(3)*(z{i}(8)^2) 0 0 0 0 2*(z{i}(3)^2)*z{i}(8) 0 0 0 0; ...
    0 0 2*z{i}(3)*(z{i}(9)^2) 0 0 0 0 0 2*(z{i}(3)^2)*z{i}(9) 0 0 0; ...
    0 0 2*z{i}(3)*(z{i}(10)^2) 0 0 0 0 0 0 2*(z{i}(3)^2)*z{i}(10) 0 0; ...
    0 0 2*z{i}(3)*(z{i}(11)^2) 0 0 0 0 0 0 0 2*(z{i}(3)^2)*z{i}(11) 0; ...
    0 0 2*z{i}(3)*(z{i}(12)^2) 0 0 0 0 0 0 0 0 2*(z{i}(3)^2)*z{i}(12); ...
    0 0 0 2*z{i}(4)*(z{i}(7)^2) 0 0 2*(z{i}(4)^2)*z{i}(7) 0 0 0 0 0; ...
    0 0 0 2*z{i}(4)*(z{i}(8)^2) 0 0 0 2*(z{i}(4)^2)*z{i}(8) 0 0 0 0; ...
    0 0 0 2*z{i}(4)*(z{i}(9)^2) 0 0 0 0 2*(z{i}(4)^2)*z{i}(9) 0 0 0; ...
    0 0 0 2*z{i}(4)*(z{i}(10)^2) 0 0 0 0 0 2*(z{i}(4)^2)*z{i}(10) 0 0; ...
    0 0 0 2*z{i}(4)*(z{i}(11)^2) 0 0 0 0 0 0 2*(z{i}(4)^2)*z{i}(11) 0; ...
    0 0 0 2*z{i}(4)*(z{i}(12)^2) 0 0 0 0 0 0 0 2*(z{i}(4)^2)*z{i}(12); ...
    0 0 0 0 2*z{i}(5)*(z{i}(7)^2) 0 2*(z{i}(5)^2)*z{i}(7) 0 0 0 0 0; ...
    0 0 0 0 2*z{i}(5)*(z{i}(8)^2) 0 0 2*(z{i}(5)^2)*z{i}(8) 0 0 0 0; ...
    0 0 0 0 2*z{i}(5)*(z{i}(9)^2) 0 0 0 2*(z{i}(5)^2)*z{i}(9) 0 0 0; ...
    0 0 0 0 2*z{i}(5)*(z{i}(10)^2) 0 0 0 0 2*(z{i}(5)^2)*z{i}(10) 0 0; ...
    0 0 0 0 2*z{i}(5)*(z{i}(11)^2) 0 0 0 0 0 2*(z{i}(5)^2)*z{i}(11) 0; ...
    0 0 0 0 2*z{i}(5)*(z{i}(12)^2) 0 0 0 0 0 0 2*(z{i}(5)^2)*z{i}(12); ...
    0 0 0 0 0 2*z{i}(6)*(z{i}(7)^2) 2*(z{i}(6)^2)*z{i}(7) 0 0 0 0 0; ...
    0 0 0 0 0 2*z{i}(6)*(z{i}(8)^2) 0 2*(z{i}(6)^2)*z{i}(8) 0 0 0 0; ...
    0 0 0 0 0 2*z{i}(6)*(z{i}(9)^2) 0 0 2*(z{i}(6)^2)*z{i}(9) 0 0 0; ...
    0 0 0 0 0 2*z{i}(6)*(z{i}(10)^2) 0 0 0 2*(z{i}(6)^2)*z{i}(10) 0 0; ...
    0 0 0 0 0 2*z{i}(6)*(z{i}(11)^2) 0 0 0 0 2*(z{i}(6)^2)*z{i}(11) 0; ...
    0 0 0 0 0 2*z{i}(6)*(z{i}(12)^2) 0 0 0 0 0 2*(z{i}(6)^2)*z{i}(12)];
end